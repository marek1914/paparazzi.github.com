<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>Paparazzi UAS: optical_flow_hover module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="penguin_icon.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Paparazzi UAS
   &#160;<span id="projectnumber">v5.13_devel-179-g48aa610-dirty</span>
   </div>
   <div id="projectbrief">Paparazzi is a free software Unmanned Aircraft System.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('module__optical_flow_hover.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">optical_flow_hover module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>This module implements monocular vision height estimation and uses this</b></p>
<p>estimate to stabilize a quadrotor using only a downwards facing camera and an IMU. For scientific background please visit: <a href="https://repository.tudelft.nl/islandora/object/uuid%3A6e3ce742-a974-491d-97c2-1cafc090b3d9">https://repository.tudelft.nl/islandora/object/uuid%3A6e3ce742-a974-491d-97c2-1cafc090b3d9</a></p>
<p>The gain height relationship as first described in <a href="http://iopscience.iop.org/article/10.1088/1748-3190/11/1/016004">http://iopscience.iop.org/article/10.1088/1748-3190/11/1/016004</a> is calibrated in a controlled environment so that the resulting relationship can be used to determine the height at which the quadrotor is flying. In addition to the vertical axis the same principle is applied to the horizontal axes.</p>
<p>A short guide on how to determine the slope: Picking a relatively high OFH_RAMP* with a very high negative OFH_COV*_SETPOINT (i.e. -6000000), looking at when the quadrotor starts oscillating, the respective message (covariances.*) should be used to determine a suitable threshold value for OFH_COV*_SETPOINT. The slope can then be decreased to gain accuracy in reaching the oscillations. Finally when flying the quadrotor on different heights the gain at which instability occurs can be noted to determine the slope of the gain-height relationship.</p>
<p>Important settings: -OFH_HOVER_METHOD/hover_method: 0, the method is applied to all 3 axes in the following order: Z - X - Y 1, the method is applied to all 3 axes at the same time 2, the method is applied to the Z axis and the estimated height is used to determine the proper gains for the horizontal axes using the predetermined relationship.</p>
<p>-XY_SYMMETRICAL is set to 1 if the drone is roughly symmetrical, causing the found gains for the X axis is also used for the Y axis. -OFH_*GAIN* can be used to set starting gains to prevent initial drift while still estimating height and appropriate gains. -OFH_REDUCTION* is used to reduce the gain after determining the oscillation to stabilize the quadrotor.</p>
<h1><a class="anchor" id="module_load_example__optical_flow_hover"></a>
Example for airframe file</h1>
<p>Add to your firmware section: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;module name=&quot;optical_flow_hover&quot;/&gt;</div>
</div><!-- fragment --> <h1><a class="anchor" id="functions__optical_flow_hover"></a>
Module functions</h1>
<h2><a class="anchor" id="init_functions"></a>
Init Functions</h2>
<p>These initialization functions are called once on startup.</p>
<ul>
<li><a class="el" href="optical__flow__hover_8c.html#ab066974e62c3e2267c4dfc11fc84d169">optical_flow_hover_init()</a></li>
</ul>
<h1><a class="anchor" id="files"></a>
Files</h1>
<h2><a class="anchor" id="headers"></a>
Header Files</h2>
<p>The following headers are automatically included in modules.h</p>
<ul>
<li><a class="el" href="optical__flow__hover_8h.html">optical_flow_hover.h</a></li>
<li><a class="el" href="optical__flow__functions_8h.html">optical_flow_functions.h</a></li>
</ul>
<h2><a class="anchor" id="sources"></a>
Source Files</h2>
<ul>
<li><a class="el" href="optical__flow__hover_8c.html">modules/ctrl/optical_flow_hover.c</a></li>
<li><a class="el" href="optical__flow__functions_8c.html">modules/ctrl/optical_flow_functions.c</a></li>
</ul>
<h2><a class="anchor" id="module_xml__optical_flow_hover"></a>
Raw optical_flow_hover.xml file:</h2>
<div class="fragment"><div class="line">&lt;!DOCTYPE module SYSTEM &quot;module.dtd&quot;&gt;</div>
<div class="line"></div>
<div class="line">&lt;module name=&quot;optical_flow_hover&quot; dir=&quot;ctrl&quot;&gt;</div>
<div class="line">  &lt;doc&gt;</div>
<div class="line">    &lt;description&gt;</div>
<div class="line">  This module implements monocular vision height estimation and uses this</div>
<div class="line">  estimate to stabilize a quadrotor using only a downwards</div>
<div class="line">  facing camera and an IMU. For scientific background please visit:</div>
<div class="line">  https://repository.tudelft.nl/islandora/object/uuid%3A6e3ce742-a974-491d-97c2-1cafc090b3d9</div>
<div class="line"></div>
<div class="line">  The gain height relationship as first described in</div>
<div class="line">  http://iopscience.iop.org/article/10.1088/1748-3190/11/1/016004 is</div>
<div class="line">  calibrated</div>
<div class="line">  in a controlled environment so that the resulting relationship can be</div>
<div class="line">  used to determine the height at which the quadrotor is flying.</div>
<div class="line">  In addition to the vertical axis the same principle is applied to the</div>
<div class="line">  horizontal axes.</div>
<div class="line"></div>
<div class="line">  A short guide on how to determine the slope:</div>
<div class="line">  Picking a relatively high OFH_RAMP* with a very high negative</div>
<div class="line">  OFH_COV*_SETPOINT (i.e. -6000000),</div>
<div class="line">  looking at when the quadrotor starts oscillating, the respective message</div>
<div class="line">  (covariances.*) should be used to determine a suitable</div>
<div class="line">  threshold value for OFH_COV*_SETPOINT. The slope can then be decreased to gain</div>
<div class="line">  accuracy in reaching the oscillations.</div>
<div class="line">  Finally when flying the quadrotor on different heights the gain at which</div>
<div class="line">  instability occurs can be noted to determine the slope of the</div>
<div class="line">  gain-height relationship.</div>
<div class="line"></div>
<div class="line">  Important settings:</div>
<div class="line">  -OFH_HOVER_METHOD/hover_method:</div>
<div class="line">  0, the method is applied to all 3 axes in the following order: Z - X - Y</div>
<div class="line">  1, the method is applied to all 3 axes at the same time</div>
<div class="line">  2, the method is applied to the Z axis and the estimated height is used</div>
<div class="line">  to determine the proper gains</div>
<div class="line">  for the horizontal axes using the predetermined relationship.</div>
<div class="line"></div>
<div class="line">  -XY_SYMMETRICAL is set to 1 if the drone is roughly symmetrical,</div>
<div class="line">  causing the found gains for the X axis is also used for the Y axis.</div>
<div class="line">  -OFH_*GAIN* can be used to set starting gains to prevent initial drift</div>
<div class="line">  while still estimating height and appropriate gains.</div>
<div class="line">  -OFH_REDUCTION* is used to reduce the gain after determining the oscillation to</div>
<div class="line">  stabilize the quadrotor.</div>
<div class="line"></div>
<div class="line">    &lt;/description&gt;</div>
<div class="line">  &lt;/doc&gt;</div>
<div class="line">  &lt;settings&gt;</div>
<div class="line">    &lt;dl_settings&gt;</div>
<div class="line">      &lt;dl_settings name=&quot;OpticalFlowHover&quot;&gt;</div>
<div class="line">        &lt;dl_settings name=&quot;General&quot;&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;cov_method&quot; min=&quot;0&quot; step=&quot;1&quot; max=&quot;1&quot; values=&quot;input|past&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;COV_METHOD&quot; param=&quot;OFH_COV_METHOD&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;hover_method&quot; min=&quot;0&quot; step=&quot;1&quot; max=&quot;2&quot; values=&quot;Sub|Same|Smart&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;HOVER_METHOD&quot; param=&quot;OFH_HOVER_METHOD&quot;/&gt;</div>
<div class="line">        &lt;/dl_settings&gt;            </div>
<div class="line">        &lt;dl_settings name=&quot;Vertical&quot;&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.cov_setpoint&quot; min=&quot;-5.05&quot; step=&quot;0.00001&quot; max=&quot;0&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;covDiv_set_point&quot; param=&quot;OFH_COVDIV_SETPOINT&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.ramp&quot; min=&quot;0&quot; step=&quot;0.005&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;rampZ&quot; param=&quot;OFH_RAMPZ&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.reduction_factor&quot; min=&quot;0.1&quot; step=&quot;0.01&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;reduction_factorZ&quot; param=&quot;OFH_REDUCTIONZ&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.PID.P&quot; min=&quot;0&quot; step=&quot;0.01&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;pgainZ&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.PID.I&quot; min=&quot;0&quot; step=&quot;0.001&quot; max=&quot;0.1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;igainZ&quot; param=&quot;OFH_IGAINZ&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Z.PID.D&quot; min=&quot;0&quot; step=&quot;0.01&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;dgainZ&quot; param=&quot;OFH_DGAINZ&quot;/&gt;              </div>
<div class="line">        &lt;/dl_settings&gt;            </div>
<div class="line">        &lt;dl_settings name=&quot;Horizontal&quot;&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.cov_setpoint&quot; min=&quot;-100000&quot; step=&quot;100&quot; max=&quot;10000&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;covFlow_set_pointX&quot; param=&quot;OFH_COVDIV_SETPOINT&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.cov_setpoint&quot; min=&quot;-100000&quot; step=&quot;100&quot; max=&quot;10000&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;covFlow_set_pointY&quot; param=&quot;OFH_COVDIV_SETPOINT&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.ramp&quot; min=&quot;0&quot; step=&quot;0.0001&quot; max=&quot;0.05&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;rampX&quot; param=&quot;OFH_RAMPXY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.ramp&quot; min=&quot;0&quot; step=&quot;0.0001&quot; max=&quot;0.05&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;rampY&quot; param=&quot;OFH_RAMPXY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.reduction_factor&quot; min=&quot;0.1&quot; step=&quot;0.01&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;reduction_factorX&quot; param=&quot;OFH_REDUCTIONXY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.reduction_factor&quot; min=&quot;0.1&quot; step=&quot;0.01&quot; max=&quot;1&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;reduction_factorY&quot; param=&quot;OFH_REDUCTIONXY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.PID.P&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.01&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;pgainX&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.PID.I&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.001&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;IgainX&quot; param=&quot;OFH_IGAINX&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_X.PID.D&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.001&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;DgainX&quot; param=&quot;OFH_DGAINX&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.PID.P&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.01&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;pgainY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.PID.I&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.001&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;IgainY&quot; param=&quot;OFH_IGAINY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;of_hover_ctrl_Y.PID.D&quot; min=&quot;0&quot; step=&quot;0.00001&quot; max=&quot;0.001&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;DgainY&quot; param=&quot;OFH_DGAINY&quot;/&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;oscphi&quot; min=&quot;0&quot; step=&quot;1&quot; max=&quot;1&quot; values=&quot;No|OSC&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;oscphi&quot; /&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;osctheta&quot; min=&quot;0&quot; step=&quot;1&quot; max=&quot;1&quot; values=&quot;No|OSC&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;osctheta&quot; /&gt;</div>
<div class="line">          &lt;dl_setting var=&quot;derotated&quot; min=&quot;0&quot; step=&quot;1&quot; max=&quot;1&quot; values=&quot;Reg|Der&quot; module=&quot;ctrl/optical_flow_hover&quot; shortname=&quot;derotated&quot; /&gt;</div>
<div class="line">        &lt;/dl_settings&gt;</div>
<div class="line">      &lt;/dl_settings&gt;</div>
<div class="line">    &lt;/dl_settings&gt;</div>
<div class="line">  &lt;/settings&gt;</div>
<div class="line"></div>
<div class="line">  &lt;header&gt;</div>
<div class="line">    &lt;file name=&quot;optical_flow_hover.h&quot; /&gt;</div>
<div class="line">    &lt;file name=&quot;optical_flow_functions.h&quot; /&gt;</div>
<div class="line">  &lt;/header&gt;</div>
<div class="line"></div>
<div class="line">  &lt;init fun=&quot;optical_flow_hover_init()&quot; /&gt;</div>
<div class="line"></div>
<div class="line">  &lt;makefile target=&quot;ap&quot;&gt;</div>
<div class="line">    &lt;file name=&quot;optical_flow_hover.c&quot; /&gt;</div>
<div class="line">    &lt;file name=&quot;optical_flow_functions.c&quot; /&gt;</div>
<div class="line">  &lt;/makefile&gt;</div>
<div class="line"></div>
<div class="line">&lt;/module&gt;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="onboard_modules.html">Onboard Modules</a></li>
    <li class="footer">Generated on Fri Apr 13 2018 10:03:01 for Paparazzi UAS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
